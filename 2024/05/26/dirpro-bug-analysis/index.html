<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="huyu's blog | Linux"><title>一次无源码Linux内核模块bug分析 | 属乌鸦的</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-129648993-1','auto');ga('send','pageview');
</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = 'https://hm.baidu.com/hm.js?' + '85d80db9310fa34ab2f7d34beeff589b';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();</script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">一次无源码Linux内核模块bug分析</h1><a id="logo" href="/.">属乌鸦的</a><p class="description">无知 &amp; 聒噪</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">一次无源码Linux内核模块bug分析</h1><div class="post-meta">May 26, 2024</div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#现象"><span class="toc-number">1.</span> <span class="toc-text">现象</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#反汇编"><span class="toc-number">2.</span> <span class="toc-text">反汇编</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#复现"><span class="toc-number">3.</span> <span class="toc-text">复现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#bug原因"><span class="toc-number">4.</span> <span class="toc-text">bug原因</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#如何正确查找task-struct"><span class="toc-number">5.</span> <span class="toc-text">如何正确查找task_struct</span></a></li></ol></div></div><div class="post-content"><p>本文记录一次无源码的Linux内核模块bug分析与复现，定位并确认dirpro模块使用了错误的方式查找task_struct，最后给出正确的查找方式。</p>
<a id="more"></a>
<h2 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h2><p>客户一台服务器出现cpu负载数值持续升高到手动重启时达到接近400、cpu使用率只有百分之三点几、ssh无法连接的情况，重启后只拿到了message日志如下。</p>
<p>可以看到cpu1处于内核态死循环，最上层栈是dirpro内核模块的函数get_process_name，次一层是同模块的new_sys_kill。</p>
<figure class="highlight plain"><figcaption><span>message</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: BUG: soft lockup - CPU#1 stuck for 67s! [wsssr_defence_d:27392]</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: Modules linked in: resguard_linux(U) secmodel_linux(U) syshook_linux(U) nls_utf8 dirpro(U) xt_multiport tcp_diag inet_diag xt_comment nf_conntrack_ipv4 nf_defrag_ipv4 xt_state nf_conntrack iptable_filter ip_tables cpufreq_ondemand acpi_cpufreq freq_table mperf bonding ib_ipoib rdma_ucm ib_ucm ib_uverbs ib_umad rdma_cm ib_cm iw_cm ib_sa ib_mad ib_core ib_addr ipv6 microcode power_meter acpi_ipmi ipmi_si ipmi_msghandler iTCO_wdt iTCO_vendor_support ses enclosure sg sb_edac edac_core i2c_i801 lpc_ich mfd_core shpchp igb dca i2c_algo_bit i2c_core ptp pps_core ext4 jbd2 mbcache sr_mod cdrom sd_mod crc_t10dif ahci aacraid wmi dm_mirror dm_region_hash dm_log dm_mod [last unloaded: nf_conntrack]</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: CPU 1</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: Modules linked in: resguard_linux(U) secmodel_linux(U) syshook_linux(U) nls_utf8 dirpro(U) xt_multiport tcp_diag inet_diag xt_comment nf_conntrack_ipv4 nf_defrag_ipv4 xt_state nf_conntrack iptable_filter ip_tables cpufreq_ondemand acpi_cpufreq freq_table mperf bonding ib_ipoib rdma_ucm ib_ucm ib_uverbs ib_umad rdma_cm ib_cm iw_cm ib_sa ib_mad ib_core ib_addr ipv6 microcode power_meter acpi_ipmi ipmi_si ipmi_msghandler iTCO_wdt iTCO_vendor_support ses enclosure sg sb_edac edac_core i2c_i801 lpc_ich mfd_core shpchp igb dca i2c_algo_bit i2c_core ptp pps_core ext4 jbd2 mbcache sr_mod cdrom sd_mod crc_t10dif ahci aacraid wmi dm_mirror dm_region_hash dm_log dm_mod [last unloaded: nf_conntrack]</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel:</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: Pid: 27392, comm: wsssr_defence_d Not tainted 2.6.32-754.6.3.el6.x86_64 #1 Inspur NF5280M4/YZMB-00689-101</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: RIP: 0010:[&lt;ffffffffa02aa510&gt;]  [&lt;ffffffffa02aa510&gt;] get_process_name+0x50/0x100 [dirpro]</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: RSP: 0018:ffff882067f97578  EFLAGS: 00000287</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: RAX: 0000000000006afc RBX: ffff882067f975c8 RCX: ffff8820684e4040</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: RDX: ffff880f903d4ab0 RSI: ffff882067f97c08 RDI: ffff882067f97c08</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: RBP: ffffffff8156513e R08: 0000000000000001 R09: 0000000000006b00</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: R10: ffffffffa02ae140 R11: 0000000000000246 R12: ffffffff8109a7ef</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: R13: ffff882067f97508 R14: 0000000000000000 R15: ffff882067f97518</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: FS:  00007fd887fff700(0000) GS:ffff880060640000(0000) knlGS:0000000000000000</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: CR2: 00000000010fda88 CR3: 0000002066c76000 CR4: 00000000001607e0</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: Process wsssr_defence_d (pid: 27392, threadinfo ffff882067f94000, task ffff8820684e4040)</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: Stack:</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: 6e696c657361626c 00000a6e61637365 ffff8810675944c0 0000000000000000</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: &lt;d&gt; ffffc900075f5a50 ffff882067f97c08 0000000000000000 0000000000006afc</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: &lt;d&gt; 0000000000000000 0000000034e20113 ffff882067f97e48 ffffffffa02ae19c</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: Call Trace:</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: [&lt;ffffffffa02ae19c&gt;] ? new_sys_kill+0x5c/0x220 [dirpro]</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: [&lt;ffffffff811bcce7&gt;] ? __d_lookup+0xa7/0x160</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: [&lt;ffffffff8120f78c&gt;] ? task_dumpable+0x3c/0x60</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: [&lt;ffffffff81243b8c&gt;] ? security_task_to_inode+0x1c/0x20</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: [&lt;ffffffff811b1522&gt;] ? do_lookup+0xa2/0x230</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: [&lt;ffffffff811bd542&gt;] ? dput+0x32/0x170</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: [&lt;ffffffff811b01d0&gt;] ? path_to_nameidata+0x20/0x60</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: [&lt;ffffffff811c7d4f&gt;] ? seq_open+0x4f/0xb0</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: [&lt;ffffffff81212940&gt;] ? proc_single_show+0x0/0xa0</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: [&lt;ffffffff81212940&gt;] ? proc_single_show+0x0/0xa0</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: [&lt;ffffffff811c7eaf&gt;] ? single_open+0x6f/0xa0</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: [&lt;ffffffff811c4600&gt;] ? mntput_no_expire+0x30/0x110</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: [&lt;ffffffff8120f690&gt;] ? proc_single_open+0x0/0x50</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: [&lt;ffffffff8119e677&gt;] ? __dentry_open+0x257/0x380</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: [&lt;ffffffff812448b5&gt;] ? security_inode_permission+0x25/0x30</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: [&lt;ffffffff8119e8b4&gt;] ? nameidata_to_filp+0x54/0x70</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: [&lt;ffffffff81156a90&gt;] ? zone_statistics+0x70/0xc0</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: [&lt;ffffffff81141721&gt;] ? get_page_from_freelist+0x3d1/0x870</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: [&lt;ffffffff811431d9&gt;] ? __alloc_pages_nodemask+0x129/0x960</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: [&lt;ffffffff8119e37f&gt;] ? do_sys_open+0xff/0x130</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: [&lt;ffffffff812af9b6&gt;] ? vsnprintf+0x336/0x5f0</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: [&lt;ffffffff8114a830&gt;] ? __lru_cache_add+0x40/0x80</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: [&lt;ffffffff8114a891&gt;] ? lru_cache_add_lru+0x21/0x40</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: [&lt;ffffffff8116a59d&gt;] ? page_add_new_anon_rmap+0x9d/0xf0</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: [&lt;ffffffff8115fcf1&gt;] ? handle_pte_fault+0x581/0xc80</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: [&lt;ffffffff812a2f71&gt;] ? cpumask_any_but+0x31/0x50</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: [&lt;ffffffff8105a708&gt;] ? flush_tlb_page+0x48/0xb0</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: [&lt;ffffffff810594dd&gt;] ? ptep_set_access_flags+0x6d/0x70</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: [&lt;ffffffffa0194b0b&gt;] ? get_hookfn+0x9b/0x1f0 [syshook_linux]</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: [&lt;ffffffffa0195b8b&gt;] ? release_context+0x20b/0x3ad0 [syshook_linux]</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: [&lt;ffffffff810b03a4&gt;] ? hrtimer_nanosleep+0xc4/0x180</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: [&lt;ffffffffa0196ce6&gt;] ? release_context+0x1366/0x3ad0 [syshook_linux]</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: [&lt;ffffffff81564357&gt;] ? system_call_fastpath+0x35/0x3a</span><br><span class="line">May 23 18:36:31 CTL_AH_225_079 kernel: [&lt;ffffffff8156427e&gt;] ? system_call_after_swapgs+0xae/0x152</span><br></pre></td></tr></table></figure>
<p>进一步查看日志，发现有crond进程长时间阻塞，共输出10次后不再输出了，对比内核代码这里默认的限制就是只输出10次。栈信息可以看到进程是在<code>synchronize_sched</code>时阻塞。之前的两篇文章<a href="/2018/11/08/rcu/">1</a>、<a href="/2024/04/11/rcu-usage/">2</a>说明了sched rcu需要每个cpu都经历过调度或在时钟中断时处于用户态才算完成一次gp，<code>sychronize_sched</code>才会完成。由于cpu1处于dirpro模块的死循环中，不满足gp的完成条件，<code>synchronize_sched</code>就会阻塞，进程进入<code>TASK_UNINTERRUPTIBLE</code>状态，处于这个状态的进程会被计算进系统负载数，rcu的gp无法完成还会造成各种异常情况。</p>
<figure class="highlight plain"><figcaption><span>message</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">May 23 18:40:01 CTL_AH_225_079 kernel: INFO: task crond:28259 blocked for more than 120 seconds.</span><br><span class="line">May 23 18:40:01 CTL_AH_225_079 kernel:      Tainted: G           --L------------    2.6.32-754.6.3.el6.x86_64 #1</span><br><span class="line">May 23 18:40:01 CTL_AH_225_079 kernel: &quot;echo 0 &gt; /proc/sys/kernel/hung_task_timeout_secs&quot; disables this message.</span><br><span class="line">May 23 18:40:01 CTL_AH_225_079 kernel: crond         D 000000000000001c     0 28259  22609 0x00000080</span><br><span class="line">May 23 18:40:01 CTL_AH_225_079 kernel: ffff8820679bfce8 0000000000000082 ffff8820679bfcb0 ffff8820679bfcac</span><br><span class="line">May 23 18:40:01 CTL_AH_225_079 kernel: ffffffff81132b44 0000000000001d43 026bd5074c8df846 ffff880060658c00</span><br><span class="line">May 23 18:40:01 CTL_AH_225_079 kernel: 0000002999d41b01 0000000000002dfe ffff88206582b068 ffff8820679bffd8</span><br><span class="line">May 23 18:40:01 CTL_AH_225_079 kernel: Call Trace:</span><br><span class="line">May 23 18:40:01 CTL_AH_225_079 kernel: [&lt;ffffffff81132b44&gt;] ? file_read_actor+0x44/0x180</span><br><span class="line">May 23 18:40:01 CTL_AH_225_079 kernel: [&lt;ffffffff81559d05&gt;] schedule_timeout+0x215/0x2f0</span><br><span class="line">May 23 18:40:01 CTL_AH_225_079 kernel: [&lt;ffffffff8134d725&gt;] ? extract_entropy+0x125/0x1f0</span><br><span class="line">May 23 18:40:01 CTL_AH_225_079 kernel: [&lt;ffffffff81559963&gt;] wait_for_common+0x123/0x180</span><br><span class="line">May 23 18:40:01 CTL_AH_225_079 kernel: [&lt;ffffffff81070890&gt;] ? default_wake_function+0x0/0x20</span><br><span class="line">May 23 18:40:01 CTL_AH_225_079 kernel: [&lt;ffffffff81559a9d&gt;] wait_for_completion+0x1d/0x20</span><br><span class="line">May 23 18:40:01 CTL_AH_225_079 kernel: [&lt;ffffffff810a6608&gt;] synchronize_sched+0x58/0x60</span><br><span class="line">May 23 18:40:01 CTL_AH_225_079 kernel: [&lt;ffffffff810a6590&gt;] ? wakeme_after_rcu+0x0/0x20</span><br><span class="line">May 23 18:40:01 CTL_AH_225_079 kernel: [&lt;ffffffff8123fb2c&gt;] install_session_keyring_to_cred+0x6c/0xd0</span><br><span class="line">May 23 18:40:01 CTL_AH_225_079 kernel: [&lt;ffffffff8124388c&gt;] ? security_prepare_creds+0x1c/0x20</span><br><span class="line">May 23 18:40:01 CTL_AH_225_079 kernel: [&lt;ffffffff8123fcce&gt;] join_session_keyring+0x13e/0x170</span><br><span class="line">May 23 18:40:01 CTL_AH_225_079 kernel: [&lt;ffffffff810f2f97&gt;] ? audit_syscall_entry+0x1d7/0x200</span><br><span class="line">May 23 18:40:01 CTL_AH_225_079 kernel: [&lt;ffffffff8123e7f8&gt;] keyctl_join_session_keyring+0x38/0x70</span><br><span class="line">May 23 18:40:01 CTL_AH_225_079 kernel: [&lt;ffffffff8123f4a0&gt;] sys_keyctl+0x180/0x1a0</span><br><span class="line">May 23 18:40:01 CTL_AH_225_079 kernel: [&lt;ffffffff81564357&gt;] system_call_fastpath+0x35/0x3a</span><br><span class="line">May 23 18:40:01 CTL_AH_225_079 kernel: [&lt;ffffffff8156427e&gt;] ? system_call_after_swapgs+0xae/0x152</span><br></pre></td></tr></table></figure>
<h2 id="反汇编"><a href="#反汇编" class="headerlink" title="反汇编"></a>反汇编</h2><p>之后进一步取到dirpro内核模块的文件，尝试反汇编。</p>
<p><img src="//blog-image.hyuuhit.com/2024/05/dirpro_dis.jpg" alt="dirpro模块get_process_name反汇编"></p>
<p>可以得到一个死循环场景：</p>
<ol>
<li>用户态程序启动一个子线程</li>
<li>子线程调用kill系统调用，pid是一个不存在的进程，或者说是一个已经退出的进程</li>
</ol>
<h2 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h2><p>尝试复现该bug，新建一个同内核版本虚拟机，安装dirpro所属的客户端，查看dirpro加载成功。</p>
<p>配置内核panic参数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sysctl kernel.panic=10</span><br><span class="line">sysctl kernel.hung_task_panic=1</span><br><span class="line">sysctl kernel.softlockup_panic=1</span><br><span class="line">sysctl kernel.nmi_watchdog=1</span><br></pre></td></tr></table></figure>
<p>编译运行一个测试程序</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">func</span><span class="params">(<span class="keyword">void</span> *arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        kill(<span class="number">11111</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"kill 11111 0\n"</span>);</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> t;</span><br><span class="line">    pthread_create(&amp;t, <span class="literal">NULL</span>, func, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Main\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>成功复现cpu死循环，内核自动panic后查看日志，与预期一致，而且只有dirpro这一个第三方内核模块存在。</p>
<figure class="highlight plain"><figcaption><span>vmcore-dmesg.txt</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">&lt;0&gt;BUG: soft lockup - CPU#1 stuck for 67s! [a.out:5114]</span><br><span class="line">&lt;4&gt;Modules linked in: dirpro(U) autofs4 8021q garp stp llc ipt_REJECT nf_conntrack_ipv4 nf_defrag_ipv4 iptable_filter ip_tables ip6t_REJECT nf_conntrack_ipv6 nf_defrag_ipv6 xt_state nf_conntrack ip6table_filter ip6_tables ib_ipoib rdma_ucm ib_ucm ib_uverbs ib_umad rdma_cm ib_cm iw_cm ib_sa ib_mad ib_core ib_addr ipv6 uinput microcode sg vmware_balloon vmxnet3 i2c_piix4 shpchp ext4 jbd2 mbcache sr_mod cdrom sd_mod crc_t10dif ahci vmw_pvscsi pata_acpi ata_generic ata_piix vmwgfx ttm drm_kms_helper drm i2c_core dm_mirror dm_region_hash dm_log dm_mod [last unloaded: speedstep_lib]</span><br><span class="line">&lt;4&gt;CPU 1</span><br><span class="line">&lt;4&gt;Modules linked in: dirpro(U) autofs4 8021q garp stp llc ipt_REJECT nf_conntrack_ipv4 nf_defrag_ipv4 iptable_filter ip_tables ip6t_REJECT nf_conntrack_ipv6 nf_defrag_ipv6 xt_state nf_conntrack ip6table_filter ip6_tables ib_ipoib rdma_ucm ib_ucm ib_uverbs ib_umad rdma_cm ib_cm iw_cm ib_sa ib_mad ib_core ib_addr ipv6 uinput microcode sg vmware_balloon vmxnet3 i2c_piix4 shpchp ext4 jbd2 mbcache sr_mod cdrom sd_mod crc_t10dif ahci vmw_pvscsi pata_acpi ata_generic ata_piix vmwgfx ttm drm_kms_helper drm i2c_core dm_mirror dm_region_hash dm_log dm_mod [last unloaded: speedstep_lib]</span><br><span class="line">&lt;4&gt;</span><br><span class="line">&lt;4&gt;Pid: 5114, comm: a.out Not tainted 2.6.32-754.6.3.el6.x86_64 #1 VMware, Inc. VMware Virtual Platform/440BX Desktop Reference Platform</span><br><span class="line">&lt;4&gt;RIP: 0010:[&lt;ffffffffa0486510&gt;]  [&lt;ffffffffa0486510&gt;] get_process_name+0x50/0x100 [dirpro]</span><br><span class="line">&lt;4&gt;RSP: 0018:ffff88013ba5b678  EFLAGS: 00000206</span><br><span class="line">&lt;4&gt;RAX: 0000000000002b67 RBX: ffff88013ba5b6c8 RCX: ffff88013ba2cab0</span><br><span class="line">&lt;4&gt;RDX: ffff88013da49520 RSI: ffff88013ba5bd08 RDI: ffff88013ba5bd08</span><br><span class="line">&lt;4&gt;RBP: ffffffff8156513e R08: 00007f19724ee700 R09: 00007f19724ee700</span><br><span class="line">&lt;4&gt;R10: 00007f19724edc20 R11: 0000000000000202 R12: ffffffff8124afd1</span><br><span class="line">&lt;4&gt;R13: ffff88013ba5b658 R14: ffff88013ba5b608 R15: 0000000000000007</span><br><span class="line">&lt;4&gt;FS:  00007f19724ee700(0000) GS:ffff880028280000(0000) knlGS:0000000000000000</span><br><span class="line">&lt;4&gt;CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033</span><br><span class="line">&lt;4&gt;CR2: 00007f2a3d3ec000 CR3: 000000013bd9e000 CR4: 00000000001607e0</span><br><span class="line">&lt;4&gt;DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000</span><br><span class="line">&lt;4&gt;DR3: 0000000000000000 DR6: 00000000ffff0ff0 DR7: 0000000000000400</span><br><span class="line">&lt;4&gt;Process a.out (pid: 5114, threadinfo ffff88013ba58000, task ffff88013ba2cab0)</span><br><span class="line">&lt;4&gt;Stack:</span><br><span class="line">&lt;4&gt; 0000000000000000 0000000000000000 0000000000000000 ffff88013ba5b6b8</span><br><span class="line">&lt;4&gt;&lt;d&gt; ffffffff81156ab9 0000000000000001 ffff88013ddd79c0 ffff8800000235c0</span><br><span class="line">&lt;4&gt;&lt;d&gt; ffff88013ba5b7e8 000000004945a606 ffff88013ba5bf48 ffffffffa048a19c</span><br><span class="line">&lt;4&gt;Call Trace:</span><br><span class="line">&lt;4&gt; [&lt;ffffffff81156ab9&gt;] ? zone_statistics+0x99/0xc0</span><br><span class="line">&lt;4&gt; [&lt;ffffffffa048a19c&gt;] ? new_sys_kill+0x5c/0x220 [dirpro]</span><br><span class="line">&lt;4&gt; [&lt;ffffffff811431d9&gt;] ? __alloc_pages_nodemask+0x129/0x960</span><br><span class="line">&lt;4&gt; [&lt;ffffffffa0489cb0&gt;] ? new_open_f+0x0/0xe0 [dirpro]</span><br><span class="line">&lt;4&gt; [&lt;ffffffff8119e677&gt;] ? __dentry_open+0x257/0x380</span><br><span class="line">&lt;4&gt; [&lt;ffffffff8114a830&gt;] ? __lru_cache_add+0x40/0x80</span><br><span class="line">&lt;4&gt; [&lt;ffffffff8114a891&gt;] ? lru_cache_add_lru+0x21/0x40</span><br><span class="line">&lt;4&gt; [&lt;ffffffff8116a59d&gt;] ? page_add_new_anon_rmap+0x9d/0xf0</span><br><span class="line">&lt;4&gt; [&lt;ffffffff8115fcf1&gt;] ? handle_pte_fault+0x581/0xc80</span><br><span class="line">&lt;4&gt; [&lt;ffffffff812b255b&gt;] ? strncpy_from_user+0x5b/0x90</span><br><span class="line">&lt;4&gt; [&lt;ffffffff81156ab9&gt;] ? zone_statistics+0x99/0xc0</span><br><span class="line">&lt;4&gt; [&lt;ffffffff81141721&gt;] ? get_page_from_freelist+0x3d1/0x870</span><br><span class="line">&lt;4&gt; [&lt;ffffffff811606f6&gt;] ? handle_mm_fault+0x306/0x450</span><br><span class="line">&lt;4&gt; [&lt;ffffffff81054e64&gt;] ? __do_page_fault+0x1f4/0x500</span><br><span class="line">&lt;4&gt; [&lt;ffffffff811431d9&gt;] ? __alloc_pages_nodemask+0x129/0x960</span><br><span class="line">&lt;4&gt; [&lt;ffffffff8106860e&gt;] ? account_entity_enqueue+0x7e/0x90</span><br><span class="line">&lt;4&gt; [&lt;ffffffff810786e2&gt;] ? enqueue_entity+0x112/0x450</span><br><span class="line">&lt;4&gt; [&lt;ffffffff81063553&gt;] ? set_next_buddy+0x43/0x50</span><br><span class="line">&lt;4&gt; [&lt;ffffffff810691d0&gt;] ? check_preempt_wakeup+0x1c0/0x260</span><br><span class="line">&lt;4&gt; [&lt;ffffffff81078b1b&gt;] ? enqueue_task_fair+0xfb/0x100</span><br><span class="line">&lt;4&gt; [&lt;ffffffff81063372&gt;] ? check_preempt_curr+0x82/0xa0</span><br><span class="line">&lt;4&gt; [&lt;ffffffff810706f6&gt;] ? try_to_wake_up+0x256/0x3f0</span><br><span class="line">&lt;4&gt; [&lt;ffffffff8106f6fe&gt;] ? perf_event_task_sched_out+0x2e/0x70</span><br><span class="line">&lt;4&gt; [&lt;ffffffff81078153&gt;] ? dequeue_entity+0x113/0x2e0</span><br><span class="line">&lt;4&gt; [&lt;ffffffff81564272&gt;] ? system_call_after_swapgs+0xa2/0x152</span><br></pre></td></tr></table></figure>
<h2 id="bug原因"><a href="#bug原因" class="headerlink" title="bug原因"></a>bug原因</h2><p>到这里可以确定是dirpro模块使用了错误的方式查找kill系统调用参数pid对应的task_struct实例，tasks链表连接从init_task开始的所有主线程，但是子线程的tasks成员只是复制了其父线程的值，在<code>copy_process</code>函数中可以看到，如果新创建的task_struct通过成员group_leader判断其不是主线程，则不会调用<code>list_add_tail_rcu(&amp;p-&gt;tasks, &amp;init_task.tasks)</code>将其链接到init_task.tasks链表中，这时子线程的tasks可以向前向后访问，但是其前后节点均指向子线程所属主线程的tasks。因此dirpro中使用的遍历方式，不会遍历回到current自身，又由于kill的目标pid已经退出，两个循环跳出条件均不会满足，因此进入了死循环。</p>
<h2 id="如何正确查找task-struct"><a href="#如何正确查找task-struct" class="headerlink" title="如何正确查找task_struct"></a>如何正确查找task_struct</h2><p>遍历所有主线程的task_struct在sched.h中有规范的使用方式如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> for_each_process(p) \</span></span><br><span class="line">    <span class="keyword">for</span> (p = &amp;init_task ; (p = next_task(p)) != &amp;init_task ; )</span><br></pre></td></tr></table></figure>
<p>如果需求是查找所有的task_struct，方式可以参考pid.c中实现</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Must be called under rcu_read_lock() or with tasklist_lock read-held.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">struct task_struct *<span class="title">find_task_by_pid_ns</span><span class="params">(<span class="keyword">pid_t</span> nr, struct pid_namespace *ns)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> pid_task(find_pid_ns(nr, ns), PIDTYPE_PID);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">struct task_struct *<span class="title">find_task_by_vpid</span><span class="params">(<span class="keyword">pid_t</span> vnr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> find_task_by_pid_ns(vnr, task_active_pid_ns(current));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div><div class="tags"><a href="/tags/linux/">linux</a></div><div class="post-nav"><a class="pre" href="/2025/04/04/executable-shared-library/">可执行的动态链接库</a><a class="next" href="/2024/05/13/elrepo-not-for-production-use/">为什么生产环境服务器不应该使用ELRepo内核</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://www.hyuuhit.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/libvirt/">libvirt</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/suricata/">suricata</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/工具/" style="font-size: 15px;">工具</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/vmware/" style="font-size: 15px;">vmware</a> <a href="/tags/数据结构/" style="font-size: 15px;">数据结构</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2025/09/21/program-crash-caused-by-wrong-return-value-type/">函数返回值类型不符导致的崩溃</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/06/08/screen-windows-auto-title/">gnu screen 自动修改窗口标题</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/06/02/stop-machine/">stop_machine 实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/05/05/static-key-jump-label/">static key & jump label</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/04/30/initcall/">initcall 机制</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/04/07/cn-proc-example/">cn_proc 进程事件连接器</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/04/04/executable-shared-library/">可执行的动态链接库</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/05/26/dirpro-bug-analysis/">一次无源码Linux内核模块bug分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/05/13/elrepo-not-for-production-use/">为什么生产环境服务器不应该使用ELRepo内核</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/04/29/memory-consistency-model-memory-barrier-and-sychronization/">内存一致性模型、内存屏障与同步</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2025 <a href="/." rel="nofollow">属乌鸦的.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>