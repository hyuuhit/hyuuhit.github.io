<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="hu yu's blog | Android | 服务端"><title>libxml2 简单使用 | 属乌鸦的</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-129648993-1','auto');ga('send','pageview');
</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = 'https://hm.baidu.com/hm.js?' + '85d80db9310fa34ab2f7d34beeff589b';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();</script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">libxml2 简单使用</h1><a id="logo" href="/.">属乌鸦的</a><p class="description">无知 &amp; 聒噪</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">libxml2 简单使用</h1><div class="post-meta">Dec 3, 2018 4:45 PM</div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#简介"><span class="toc-number">1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#数据结构"><span class="toc-number">2.</span> <span class="toc-text">数据结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#xmlDoc"><span class="toc-number">2.1.</span> <span class="toc-text">xmlDoc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#xmlChar"><span class="toc-number">2.2.</span> <span class="toc-text">xmlChar</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#xmlAttr"><span class="toc-number">2.3.</span> <span class="toc-text">xmlAttr</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#xmlNode"><span class="toc-number">2.4.</span> <span class="toc-text">xmlNode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#xmlXPathObject"><span class="toc-number">2.5.</span> <span class="toc-text">xmlXPathObject</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用例子"><span class="toc-number">3.</span> <span class="toc-text">使用例子</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#生成XML"><span class="toc-number">3.1.</span> <span class="toc-text">生成XML</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解析XML"><span class="toc-number">3.2.</span> <span class="toc-text">解析XML</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#XPath查找"><span class="toc-number">3.3.</span> <span class="toc-text">XPath查找</span></a></li></ol></li></ol></div></div><div class="post-content"><p>libxml2是一个用于XML解析的开发工具包，提供C语言接口。这里简单记录使用libxml2进行XML数据生成、解析及使用XPath语法进行节点选取的基本操作。</p>
<a id="more"></a>
<p>本文操作系统环境为 CentOS Linux release 7.5.1804，libxml2版本为libxml2-2.9.1-6。</p>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>XML（可扩展标记语言）的定义及其结构和结构名称可以参考<a href="https://zh.wikipedia.org/wiki/XML" target="_blank" rel="noopener">维基百科</a>。这里简单关注几个与后文<code>xmlNode</code>结构有关的概念：</p>
<ul>
<li>标记（tag）<br>XML既然是一种标记语言，肯定会有标记的概念，这里可以不严谨的理解为<code>&lt;</code>符号开始与<code>&gt;</code>符号结束的一段文本，比如<ul>
<li><code>&lt;section&gt;</code>是开始标记</li>
<li><code>&lt;/section&gt;</code>是结束标记</li>
<li><code>&lt;section/&gt;</code>是空元素标记</li>
</ul>
</li>
<li>内容（content）<br>XML中标记之外的部分就是内容。在libxml2中内容与元素一样都对应一个<code>xmlNode</code>，只是其type为<code>XML_TEXT_NODE</code>，其<code>content</code>成员保存了内容字符串，而且其作为外层元素<code>xmlNode</code>的子节点存在。</li>
<li>元素（element）<br>元素是一个逻辑概念，一种是开始标记与对应的结束标记及其中间的所有内容和其他子元素，另一种是一个空元素标记作为一个元素存在。在libxml2中一个元素对应一个<code>xmlNode</code>，其type为<code>XML_ELEMENT_NODE</code>。</li>
<li>属性（attribute）<br>属性是元素的内部结构，以键值对存在。在libxml2中对应一个<code>xmlAttr</code>结构。<code>xmlNode</code>中的属性由其成员<code>properties</code>链接管理。</li>
</ul>
<p>libxml2项目官网为<a href="http://xmlsoft.org/index.html" target="_blank" rel="noopener">http://xmlsoft.org/index.html</a>。</p>
<p>PS：我能说github上拉的源码缩进简直反人类么。</p>
<p>可以使用命令<code>yum install libxml2-devel</code>安装rpm包及依赖。<code>/usr/bin/xml2-config</code>命令指示了编译需要的相关参数，比如为了查找头文件需要编译参数<code>-I/usr/include/libxml2</code>，链接需要参数<code>-lxml2</code>。</p>
<h2 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h2><h3 id="xmlDoc"><a href="#xmlDoc" class="headerlink" title="xmlDoc"></a><code>xmlDoc</code></h3><p>对于XML数据文档的整体使用<code>xmlDoc</code>结构体类型表示，这个结构体的内部成员可以暂时无视，使用api进行操作是正确的访问方式。更多时候使用<code>xmlDocPtr</code>类型代表<code>xmlDoc</code>的指针，定义为<code>typedef xmlDoc *xmlDocPtr;</code>。</p>
<h3 id="xmlChar"><a href="#xmlChar" class="headerlink" title="xmlChar"></a><code>xmlChar</code></h3><p>libxml2中字符使用使用<code>xmlChar</code>类型，其实就是<code>unsigned char</code>，那么字符串就是<code>xmlChar *</code>了，对于<code>char *</code>转换为<code>xmlChar *</code>提供了宏<code>BAD_CAST</code>，不过无视这个宏而使用直接的强制类型转换也没什么不好，需要注意的是应该全局使用UTF-8编码。我不想考虑非UTF-8编码的情况了，不要给自己创造麻烦。</p>
<h3 id="xmlAttr"><a href="#xmlAttr" class="headerlink" title="xmlAttr"></a><code>xmlAttr</code></h3><p>XML中属性使用<code>xmlAttr</code>结构表示，该结构由元素<code>xmlNode</code>成员<code>properties</code>引用。<code>xmlAttr</code>结构的前面部分与<code>xmlNode</code>一致，在XPath返回的结果中，<code>xmlAttr</code>指针会被强制转换为<code>xmlNode</code>指针，可以使用type字段区分具体的类型。</p>
<figure class="highlight c"><figcaption><span>xmlAttr</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * xmlAttr:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * An attribute on an XML node.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">xmlAttr</span> <span class="title">xmlAttr</span>;</span></span><br><span class="line"><span class="keyword">typedef</span> xmlAttr *xmlAttrPtr;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">xmlAttr</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span>           *_private;   <span class="comment">/* application data */</span></span><br><span class="line">    xmlElementType   type;      <span class="comment">/* XML_ATTRIBUTE_NODE, must be second ! */</span></span><br><span class="line">    <span class="keyword">const</span> xmlChar   *name;      <span class="comment">/* the name of the property */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">xmlNode</span> *<span class="title">children</span>;</span>  <span class="comment">/* the value of the property */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">xmlNode</span> *<span class="title">last</span>;</span>  <span class="comment">/* NULL */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">xmlNode</span> *<span class="title">parent</span>;</span>    <span class="comment">/* child-&gt;parent link */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">xmlAttr</span> *<span class="title">next</span>;</span>  <span class="comment">/* next sibling link  */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">xmlAttr</span> *<span class="title">prev</span>;</span>  <span class="comment">/* previous sibling link  */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">xmlDoc</span>  *<span class="title">doc</span>;</span>   <span class="comment">/* the containing document */</span></span><br><span class="line">    xmlNs           *ns;        <span class="comment">/* pointer to the associated namespace */</span></span><br><span class="line">    xmlAttributeType atype;     <span class="comment">/* the attribute type if validating */</span></span><br><span class="line">    <span class="keyword">void</span>            *psvi;  <span class="comment">/* for type/PSVI informations */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>type<br>固定为XML_ATTRIBUTE_NODE。</li>
<li>name<br>属性的key</li>
<li>children<br><code>xmlNode</code>结构，<code>type</code>为<code>XML_TEXT_NODE</code>，<code>content</code>成员保存了属性的value。</li>
<li>next、prev<br>用于链接同一个元素节点的其他属性。</li>
</ul>
<h3 id="xmlNode"><a href="#xmlNode" class="headerlink" title="xmlNode"></a><code>xmlNode</code></h3><p>每个元素（element）和内容（content）使用<code>xmlNode</code>结构体类型表示，同样有一个<code>xmlNodePtr</code>代表其指针。</p>
<figure class="highlight c"><figcaption><span>xmlNode</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * xmlNode:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * A node in an XML tree.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">xmlNode</span> <span class="title">xmlNode</span>;</span></span><br><span class="line"><span class="keyword">typedef</span> xmlNode *xmlNodePtr;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">xmlNode</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span>           *_private;   <span class="comment">/* application data */</span></span><br><span class="line">    xmlElementType   type;  <span class="comment">/* type number, must be second ! */</span></span><br><span class="line">    <span class="keyword">const</span> xmlChar   *name;      <span class="comment">/* the name of the node, or the entity */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">xmlNode</span> *<span class="title">children</span>;</span>  <span class="comment">/* parent-&gt;childs link */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">xmlNode</span> *<span class="title">last</span>;</span>  <span class="comment">/* last child link */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">xmlNode</span> *<span class="title">parent</span>;</span>    <span class="comment">/* child-&gt;parent link */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">xmlNode</span> *<span class="title">next</span>;</span>  <span class="comment">/* next sibling link  */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">xmlNode</span> *<span class="title">prev</span>;</span>  <span class="comment">/* previous sibling link  */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">xmlDoc</span>  *<span class="title">doc</span>;</span>   <span class="comment">/* the containing document */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* End of common part */</span></span><br><span class="line">    xmlNs           *ns;        <span class="comment">/* pointer to the associated namespace */</span></span><br><span class="line">    xmlChar         *content;   <span class="comment">/* the content */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">xmlAttr</span> *<span class="title">properties</span>;</span><span class="comment">/* properties list */</span></span><br><span class="line">    xmlNs           *nsDef;     <span class="comment">/* namespace definitions on this node */</span></span><br><span class="line">    <span class="keyword">void</span>            *psvi;  <span class="comment">/* for type/PSVI informations */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">short</span>   line;  <span class="comment">/* line number */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">short</span>   extra; <span class="comment">/* extra data for XPath/XSLT */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>type<br><code>xmlNode</code>的节点类型，枚举类型，值比较多，可以参考<a href="http://xmlsoft.org/html/libxml-tree.html#xmlElementType" target="_blank" rel="noopener">官网文档</a>。这里主要关注三种类型<ul>
<li><code>XML_ELEMENT_NODE</code><br>对应XML结构中的元素。</li>
<li><code>XML_TEXT_NODE</code><br>对应XML中的内容。</li>
<li><code>XML_ATTRIBUTE_NODE</code><br>如果是该类型，说明该<code>xmlNode</code>实际是<code>xmlAttr</code>。</li>
</ul>
</li>
<li>children<br><code>xmlNode</code>的子节点。</li>
<li>next、prev<br>用于链接同一个父节点的其他<code>xmlNode</code>。</li>
<li>name<br>如果是<code>XML_ELEMENT_NODE</code>元素类型，name就是元素名字。如果是<code>XML_TEXT_NODE</code>XML内容类型，name就是固定字符串text。</li>
<li>content<br>如果是<code>XML_TEXT_NODE</code>XML内容类型，content保存了其内容字符串。</li>
</ul>
<p>以下面<a href="./#xmlfile">例子中生成的XML文档</a>为例，<code>xmlNode</code>中各成员组织关系如下图：</p>
<p><img src="http://blog-image.hyuuhit.com/2018/12/libxml2.jpg" alt="xmlNode成员组织关系"></p>
<h3 id="xmlXPathObject"><a href="#xmlXPathObject" class="headerlink" title="xmlXPathObject"></a><code>xmlXPathObject</code></h3><p>XPath查询结果结构体，<code>xmlXPathEval</code>函数返回其指针类型<code>xmlXPathObjectPtr</code>。</p>
<ul>
<li>type<br>标识了其内部有效的具体成员，类型比较多，可以参考<a href="http://xmlsoft.org/html/libxml-xpath.html#xmlXPathObjectType" target="_blank" rel="noopener">官网文档</a>。这里介绍几种：<ul>
<li><code>XPATH_NODESET</code><br><code>xmlXPathEval</code>返回后总是<code>XPATH_NODESET</code>类型，标识其成员<code>nodesetval</code>中保存了符合查询条件的<code>xmlNode</code>节点指针数组，如果查询的是属性，<code>xmlAttr</code>指针也会保存于该<code>xmlNode</code>节点指针数组中。这个数组仅保存符合条件的节点的指针，指向了<code>xmlDoc</code>中的具体数据结构，而不是重新分配的内存，因此不要尝试修改其内容。如果没有匹配的节点，返回值的<code>nodesetval</code>会为<code>NULL</code>，需要判断该情况。</li>
<li><code>XPATH_BOOLEAN</code>、<code>XPATH_NUMBER</code>、<code>XPATH_STRING</code><br>由于<code>xmlXPathEval</code>并不会返回该类型的结果，因此意义不大。可以通过对<code>XPATH_NODESET</code>类型的结果调用函数<code>xmlXPathConvertString</code>将<code>nodesetval</code>中的第一个<code>xmlNode</code>的内容字符串存储于<code>stringval</code>成员，其他类型同理。</li>
</ul>
</li>
<li>nodesetval<br>该结构体的主要成员，内部数组成员<code>nodeTab</code>保存了查找到的符合条件的每个节点指针。</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * A node-set (an unordered collection of nodes without duplicates).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">xmlNodeSet</span> <span class="title">xmlNodeSet</span>;</span></span><br><span class="line"><span class="keyword">typedef</span> xmlNodeSet *xmlNodeSetPtr;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">xmlNodeSet</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> nodeNr;         <span class="comment">/* number of nodes in the set */</span></span><br><span class="line">    <span class="keyword">int</span> nodeMax;        <span class="comment">/* size of the array as allocated */</span></span><br><span class="line">    xmlNodePtr *nodeTab;    <span class="comment">/* array of nodes in no particular order */</span></span><br><span class="line">    <span class="comment">/* @@ with_ns to check wether namespace nodes should be looked at @@ */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * An expression is evaluated to yield an object, which</span></span><br><span class="line"><span class="comment"> * has one of the following four basic types:</span></span><br><span class="line"><span class="comment"> *   - node-set</span></span><br><span class="line"><span class="comment"> *   - boolean</span></span><br><span class="line"><span class="comment"> *   - number</span></span><br><span class="line"><span class="comment"> *   - string</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @@ XPointer will add more types !</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> &#123;</span><br><span class="line">    XPATH_UNDEFINED = <span class="number">0</span>,</span><br><span class="line">    XPATH_NODESET = <span class="number">1</span>,</span><br><span class="line">    XPATH_BOOLEAN = <span class="number">2</span>,</span><br><span class="line">    XPATH_NUMBER = <span class="number">3</span>,</span><br><span class="line">    XPATH_STRING = <span class="number">4</span>,</span><br><span class="line">    XPATH_POINT = <span class="number">5</span>,</span><br><span class="line">    XPATH_RANGE = <span class="number">6</span>,</span><br><span class="line">    XPATH_LOCATIONSET = <span class="number">7</span>,</span><br><span class="line">    XPATH_USERS = <span class="number">8</span>,</span><br><span class="line">    XPATH_XSLT_TREE = <span class="number">9</span>  <span class="comment">/* An XSLT value tree, non modifiable */</span></span><br><span class="line">&#125; xmlXPathObjectType;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">xmlXPathObject</span> <span class="title">xmlXPathObject</span>;</span></span><br><span class="line"><span class="keyword">typedef</span> xmlXPathObject *xmlXPathObjectPtr;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">xmlXPathObject</span> &#123;</span></span><br><span class="line">    xmlXPathObjectType type;</span><br><span class="line">    xmlNodeSetPtr nodesetval;</span><br><span class="line">    <span class="keyword">int</span> boolval;</span><br><span class="line">    <span class="keyword">double</span> floatval;</span><br><span class="line">    xmlChar *stringval;</span><br><span class="line">    <span class="keyword">void</span> *user;</span><br><span class="line">    <span class="keyword">int</span> index;</span><br><span class="line">    <span class="keyword">void</span> *user2;</span><br><span class="line">    <span class="keyword">int</span> index2;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="使用例子"><a href="#使用例子" class="headerlink" title="使用例子"></a>使用例子</h2><p>以下记录了几种简单使用例子。更多使用方式可以参考<a href="http://xmlsoft.org/tutorial/index.html" target="_blank" rel="noopener">官网tutorial</a>以及<a href="http://xmlsoft.org/html/index.html" target="_blank" rel="noopener">API</a>，本文使用的api主要为<a href="http://xmlsoft.org/html/libxml-tree.html" target="_blank" rel="noopener">tree</a>、<a href="http://xmlsoft.org/html/libxml-xpath.html" target="_blank" rel="noopener">xpath</a>、<a href="http://xmlsoft.org/html/libxml-parser.html" target="_blank" rel="noopener">parser</a>三部分。</p>
<p>PS：生产环境需要更细致的错误检查。libxml2使用时需要注意及时释放不再访问的资源以防内存泄漏。</p>
<h3 id="生成XML"><a href="#生成XML" class="headerlink" title="生成XML"></a>生成XML</h3><p>这里以libvirt可以接受的network格式为例，生成XML格式字符串。调用的主要函数为：</p>
<ul>
<li><code>xmlNewDoc</code><br>创建一个xmlDoc结构并返回指针。</li>
<li><code>xmlNewNode</code><br>创建一个<code>xmlNode</code>结构并返回指针，<code>type</code>为<code>XML_ELEMENT_NODE</code>。</li>
<li><code>xmlDocSetRootElement</code><br>将一个<code>xmlNode</code>设置为<code>xmlDoc</code>的根节点。</li>
<li><code>xmlNewText</code><br>创建一个<code>xmlNode</code>结构，<code>type</code>为<code>XML_TEXT_NODE</code>，<code>content</code>为参数字符串。</li>
<li><code>xmlAddChild</code><br>将一个<code>xmlNode</code>做为另一个的子元素插入。</li>
<li><code>xmlNewProp</code><br>创建一个以参数作为键值对的<code>xmlAttr</code>并插入到一个<code>xmlNode</code>中作为属性。</li>
<li><code>xmlDocDumpFormatMemory</code><br>将<code>xmlDoc</code>以格式化XML文本的形式输出内存字符串。</li>
<li><code>xmlSaveFormatFile</code><br>将<code>xmlDoc</code>以格式化XML文本的形式输出到文件。</li>
</ul>
<figure class="highlight c"><figcaption><span>create.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libxml/parser.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">create_doc</span><span class="params">(<span class="keyword">char</span> *file)</span> </span>&#123;</span><br><span class="line">    xmlDocPtr doc;</span><br><span class="line">    xmlNodePtr root;</span><br><span class="line">    xmlNodePtr node;</span><br><span class="line">    xmlNodePtr node2;</span><br><span class="line">    xmlChar *buf;</span><br><span class="line">    <span class="keyword">int</span> len;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* new doc */</span></span><br><span class="line">    doc = xmlNewDoc(<span class="literal">NULL</span>);</span><br><span class="line">    root = xmlNewNode(<span class="literal">NULL</span>, BAD_CAST(<span class="string">"network"</span>));</span><br><span class="line">    xmlDocSetRootElement(doc, root);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 加入name */</span></span><br><span class="line">    node = xmlNewNode(<span class="literal">NULL</span>, BAD_CAST(<span class="string">"name"</span>));</span><br><span class="line">    node2 = xmlNewText(BAD_CAST(<span class="string">"s-engine-net"</span>));</span><br><span class="line">    xmlAddChild(node, node2);</span><br><span class="line">    xmlAddChild(root, node);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 加入bridge */</span></span><br><span class="line">    node = xmlNewNode(<span class="literal">NULL</span>, BAD_CAST(<span class="string">"bridge"</span>));</span><br><span class="line">    xmlNewProp(node, BAD_CAST(<span class="string">"name"</span>), BAD_CAST(<span class="string">"s-engine-br0"</span>));</span><br><span class="line">    xmlNewProp(node, BAD_CAST(<span class="string">"stp"</span>), BAD_CAST(<span class="string">"on"</span>));</span><br><span class="line">    xmlNewProp(node, BAD_CAST(<span class="string">"delay"</span>), BAD_CAST(<span class="string">"0"</span>));</span><br><span class="line">    xmlAddChild(root, node);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 加入ip */</span></span><br><span class="line">    node = xmlNewNode(<span class="literal">NULL</span>, BAD_CAST(<span class="string">"ip"</span>));</span><br><span class="line">    xmlNewProp(node, BAD_CAST(<span class="string">"address"</span>), BAD_CAST(<span class="string">"172.16.0.1"</span>));</span><br><span class="line">    xmlNewProp(node, BAD_CAST(<span class="string">"netmask"</span>), BAD_CAST(<span class="string">"255.255.0.0"</span>));</span><br><span class="line">    xmlAddChild(root, node);</span><br><span class="line">    node2 = xmlNewNode(<span class="literal">NULL</span>, BAD_CAST(<span class="string">"dhcp"</span>));</span><br><span class="line">    xmlAddChild(node, node2);</span><br><span class="line">    node = xmlNewNode(<span class="literal">NULL</span>, BAD_CAST(<span class="string">"range"</span>));</span><br><span class="line">    xmlNewProp(node, BAD_CAST(<span class="string">"start"</span>), BAD_CAST(<span class="string">"172.16.100.100"</span>));</span><br><span class="line">    xmlNewProp(node, BAD_CAST(<span class="string">"end"</span>), BAD_CAST(<span class="string">"172.16.100.254"</span>));</span><br><span class="line">    xmlAddChild(node2, node);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 输出到内存 */</span></span><br><span class="line">    xmlDocDumpFormatMemory(doc, &amp;buf, &amp;len, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (len &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%s\n"</span>, buf);</span><br><span class="line">        <span class="built_in">free</span>(buf);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 输出到文件 */</span></span><br><span class="line">    <span class="keyword">if</span> (xmlSaveFormatFile(file, doc, <span class="number">1</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"failed to save file \"%s\"\n."</span>, file);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 释放内存 */</span></span><br><span class="line">    xmlFreeDoc(doc);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argc &lt; <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Usage: %s filename\n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    create_doc(argv[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译</p>
<p><code>gcc -Wall -g -I /usr/include/libxml2 -lxml2 create.c -o create</code></p>
<p>执行</p>
<p><code>./create tt</code></p>
<p><span id="xmlfile">输出及文件内容均为</span></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">network</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>s-engine-net<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bridge</span> <span class="attr">name</span>=<span class="string">"s-engine-br0"</span> <span class="attr">stp</span>=<span class="string">"on"</span> <span class="attr">delay</span>=<span class="string">"0"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ip</span> <span class="attr">address</span>=<span class="string">"172.16.0.1"</span> <span class="attr">netmask</span>=<span class="string">"255.255.0.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dhcp</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">range</span> <span class="attr">start</span>=<span class="string">"172.16.100.100"</span> <span class="attr">end</span>=<span class="string">"172.16.100.254"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dhcp</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ip</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">network</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="解析XML"><a href="#解析XML" class="headerlink" title="解析XML"></a>解析XML</h3><p>这里演示如何递归解析刚刚生成的XML文件，包括元素、属性和内容的解析。</p>
<figure class="highlight c"><figcaption><span>parse.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libxml/parser.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">xmlChar *bridge_name = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 递归遍历 */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">parse_node</span><span class="params">(xmlNodePtr node, <span class="keyword">int</span> space)</span> </span>&#123;</span><br><span class="line">    xmlNodePtr cur;</span><br><span class="line">    xmlAttr *attr;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 解析元素 */</span></span><br><span class="line">    <span class="keyword">if</span> (node-&gt;type == XML_ELEMENT_NODE) &#123;</span><br><span class="line">        <span class="keyword">int</span> i;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; space; i++) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">" "</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%s"</span>, node-&gt;name);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 例子：查找attr */</span></span><br><span class="line">        <span class="keyword">if</span> (xmlStrcmp(node-&gt;name, BAD_CAST(<span class="string">"bridge"</span>)) == <span class="number">0</span>) &#123;</span><br><span class="line">            bridge_name = xmlGetProp(node, BAD_CAST(<span class="string">"name"</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cur = node-&gt;children;</span><br><span class="line">        <span class="keyword">if</span> (cur != <span class="literal">NULL</span> &amp;&amp; cur-&gt;type == XML_TEXT_NODE &amp;&amp; cur-&gt;next == <span class="literal">NULL</span> &amp;&amp; cur-&gt;prev == <span class="literal">NULL</span>)</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">": \"%s\""</span>, cur-&gt;content);</span><br><span class="line"></span><br><span class="line">        i = <span class="number">0</span>;</span><br><span class="line">        attr = node-&gt;properties;</span><br><span class="line">        <span class="keyword">while</span> (attr != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * attr-&gt;children是一个xmlNode，文本类型，这个函数取该xmlNode的content</span></span><br><span class="line"><span class="comment">             * 后面会有更清晰的例子</span></span><br><span class="line"><span class="comment">             * */</span></span><br><span class="line">            xmlChar *str = xmlNodeListGetString(node-&gt;doc, attr-&gt;children, <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> (i == <span class="number">0</span>) &#123;</span><br><span class="line">                i = <span class="number">1</span>;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"(%s=\"%s\""</span>, attr-&gt;name, str);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">" %s=\"%s\""</span>, attr-&gt;name, str);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">free</span>(str);</span><br><span class="line">            attr = attr-&gt;next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (i != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">")"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cur = node-&gt;children;</span><br><span class="line">        <span class="keyword">while</span> (cur != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="comment">/* 递归 */</span></span><br><span class="line">            parse_node(cur, space + <span class="number">2</span>);</span><br><span class="line">            cur = cur-&gt;next;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node-&gt;type == XML_TEXT_NODE) &#123;</span><br><span class="line">        <span class="comment">/* 例子，XML格式化造成的多余content */</span></span><br><span class="line">        <span class="keyword">if</span> (node-&gt;next != <span class="literal">NULL</span> || node-&gt;prev != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> i;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; space; i++) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">" "</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"# USELESS CONTENT #"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">parse_doc</span><span class="params">(<span class="keyword">char</span> *file)</span> </span>&#123;</span><br><span class="line">    xmlDocPtr doc;</span><br><span class="line">    xmlNodePtr root;</span><br><span class="line"></span><br><span class="line">    doc = xmlParseFile(file);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (doc == <span class="literal">NULL</span> ) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"failed to parse file \"%s\".\n"</span>, file);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    root = xmlDocGetRootElement(doc);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (root == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"empty document\n"</span>);</span><br><span class="line">        xmlFreeDoc(doc);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    parse_node(root, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n\n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 查找attr的结果 */</span></span><br><span class="line">    <span class="keyword">if</span> (bridge_name) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"find bridge attr name: %s\n"</span>, bridge_name);</span><br><span class="line">        <span class="built_in">free</span>(bridge_name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    xmlFreeDoc(doc);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* xmlNodeListGetString，可以看到返回了"c1"和"c2"两个字符串拼接的结果 */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    xmlDocPtr doc;</span><br><span class="line">    xmlNodePtr node;</span><br><span class="line">    xmlChar *str = BAD_CAST(<span class="string">"&lt;e1&gt;c1&lt;e2/&gt;c2&lt;/e1&gt;"</span>);</span><br><span class="line"></span><br><span class="line">    doc = xmlParseDoc(str);</span><br><span class="line">    node = xmlDocGetRootElement(doc);</span><br><span class="line">    str = xmlNodeListGetString(doc, node-&gt;children, <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"test example: \"%s\"\n"</span>, str);</span><br><span class="line">    <span class="built_in">free</span>(str);</span><br><span class="line">    xmlFreeDoc(doc);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argc &lt; <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Usage: %s filename\n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    parse_doc(argv[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    test();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译</p>
<p><code>gcc -Wall -g -I /usr/include/libxml2 -lxml2 parse.c -o parse</code></p>
<p>执行</p>
<p><code>./parse tt</code></p>
<p>输出<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">network</span><br><span class="line">  # USELESS CONTENT #</span><br><span class="line">  name: &quot;s-engine-net&quot;(k=&quot;v&quot;)</span><br><span class="line">  # USELESS CONTENT #</span><br><span class="line">  bridge(name=&quot;s-engine-br0&quot; stp=&quot;on&quot; delay=&quot;0&quot;)</span><br><span class="line">  # USELESS CONTENT #</span><br><span class="line">  ip(address=&quot;172.16.0.1&quot; netmask=&quot;255.255.0.0&quot;)</span><br><span class="line">    # USELESS CONTENT #</span><br><span class="line">    dhcp</span><br><span class="line">      # USELESS CONTENT #</span><br><span class="line">      range(start=&quot;172.16.100.100&quot; end=&quot;172.16.100.254&quot;)</span><br><span class="line">      # USELESS CONTENT #</span><br><span class="line">    # USELESS CONTENT #</span><br><span class="line">  # USELESS CONTENT #</span><br><span class="line"></span><br><span class="line">find bridge attr name: s-engine-br0</span><br><span class="line">test example: &quot;c1c2&quot;</span><br></pre></td></tr></table></figure></p>
<h3 id="XPath查找"><a href="#XPath查找" class="headerlink" title="XPath查找"></a>XPath查找</h3><p>XPath具体语法可以参考<a href="https://zh.wikipedia.org/wiki/XPath" target="_blank" rel="noopener">维基百科</a>。查找的到节点集合的结构关系参考前文<a href="./#xmlXPathObject">xmlXPathObject结构体</a></p>
<p>这里主要使用的就是两个XPath相关函数：</p>
<ul>
<li><code>xmlXPathNewContext</code><br>由<code>xmlDoc</code>指针生成XPath的上下文。</li>
<li><code>xmlXPathEval</code><br>在XPath上下文中执行指定字符串的查询。</li>
</ul>
<figure class="highlight c"><figcaption><span>search.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libxml/parser.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libxml/xpath.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">search_doc</span><span class="params">(xmlXPathContextPtr context, <span class="keyword">char</span> *search_string)</span> </span>&#123;</span><br><span class="line">    xmlChar *str = BAD_CAST(search_string);</span><br><span class="line">    xmlXPathObjectPtr result;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"search string: \"%s\"\n"</span>, search_string);</span><br><span class="line">    result = xmlXPathEval(str, context);</span><br><span class="line">    <span class="keyword">if</span> (result == <span class="literal">NULL</span> || result-&gt;nodesetval == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"  found nothing\n"</span>);</span><br><span class="line">        <span class="keyword">goto</span> err_ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; result-&gt;nodesetval-&gt;nodeNr; i++) &#123;</span><br><span class="line">        xmlNodePtr node = result-&gt;nodesetval-&gt;nodeTab[i];</span><br><span class="line">        <span class="keyword">if</span> (node-&gt;type == XML_ELEMENT_NODE) &#123;</span><br><span class="line">            xmlChar *s = xmlNodeListGetString(node-&gt;doc, node-&gt;children, <span class="number">1</span>);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"  [%d] element: \"%s\" \"%s\"\n"</span>, i, node-&gt;name, s);</span><br><span class="line">            <span class="built_in">free</span>(s);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node-&gt;type == XML_ATTRIBUTE_NODE) &#123;</span><br><span class="line">            xmlChar *s = xmlNodeListGetString(node-&gt;doc, node-&gt;children, <span class="number">1</span>);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"  [%d] attribute: \"%s\" \"%s\"\n"</span>, i, node-&gt;name, s);</span><br><span class="line">            <span class="built_in">free</span>(s);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"  [%d] type %d: \"%s\"\n"</span>, i, node-&gt;type, node-&gt;name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">err_ret:</span><br><span class="line">    <span class="keyword">if</span> (result != <span class="literal">NULL</span>)</span><br><span class="line">        xmlXPathFreeObject(result);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    xmlDocPtr doc;</span><br><span class="line">    xmlXPathContextPtr context;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argc &lt; <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Usage: %s docname\n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    doc = xmlParseFile(argv[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">if</span> (doc == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"failed to parse file \"%s\".\n"</span>, argv[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    context = xmlXPathNewContext(doc);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 测试 */</span></span><br><span class="line">    search_doc(context, <span class="string">"/network[1]/ip[1]/@address[1] | /network[1]/name[1]"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 这个用于libvirt搜索domain第一个网卡MAC地址 */</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">       search_doc(context, "/domain[1]/devices[1]/interface[1]/mac[1]/@address[1]");</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 释放资源 */</span></span><br><span class="line">    xmlXPathFreeContext(context);</span><br><span class="line">    xmlFreeDoc(doc);</span><br><span class="line">    xmlCleanupParser();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译</p>
<p><code>gcc -Wall -g -I /usr/include/libxml2 -lxml2 search.c -o search</code></p>
<p>执行</p>
<p><code>./search tt</code></p>
<p>输出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">search string: &quot;/network[1]/ip[1]/@address[1] | /network[1]/name[1]&quot;</span><br><span class="line">  [0] element: &quot;name&quot; &quot;s-engine-net&quot;</span><br><span class="line">  [1] attribute: &quot;address&quot; &quot;172.16.0.1&quot;</span><br></pre></td></tr></table></figure>
</div><div class="tags"><a href="/tags/工具/">工具</a></div><div class="post-nav"><a class="pre" href="/2018/12/13/nwfilter/">libvirt nwfilter 简单使用</a><a class="next" href="/2018/11/20/virt-install/">virt-install 简单使用</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://www.hyuuhit.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/libvirt/">libvirt</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/suricata/">suricata</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/工具/" style="font-size: 15px;">工具</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/vmware/" style="font-size: 15px;">vmware</a> <a href="/tags/数据结构/" style="font-size: 15px;">数据结构</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/08/20/bash-invocation/">bash 调用方式与配置文件</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/08/17/uriparser/">uriparser 解析处理URI</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/06/noblock-rabbitmq-c/">rabbitmq-c 非阻塞订阅</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/20/libyaml/">libyaml 解析配置文件</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/23/netns/">Linux network namespace 简单解读</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/11/af-packet-bpf/">AF_PACKET & BPF 伪造arp响应</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/04/nonblock-redis/">hiredis & libev 非阻塞模式</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/13/nwfilter/">libvirt nwfilter 简单使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/03/libxml2/">libxml2 简单使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/20/virt-install/">virt-install 简单使用</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">属乌鸦的.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>