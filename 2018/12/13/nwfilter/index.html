<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="hu yu's blog | Android | 服务端"><title>libvirt nwfilter 简单使用 | 属乌鸦的</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-129648993-1','auto');ga('send','pageview');
</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = 'https://hm.baidu.com/hm.js?' + '85d80db9310fa34ab2f7d34beeff589b';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();</script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">libvirt nwfilter 简单使用</h1><a id="logo" href="/.">属乌鸦的</a><p class="description">无知 &amp; 聒噪</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">libvirt nwfilter 简单使用</h1><div class="post-meta">Dec 13, 2018<span> | </span><span class="category"><a href="/categories/libvirt/">libvirt</a></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#概念"><span class="toc-number">1.</span> <span class="toc-text">概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#chain"><span class="toc-number">2.</span> <span class="toc-text">chain</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#实现"><span class="toc-number">2.1.</span> <span class="toc-text">实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#priority"><span class="toc-number">3.</span> <span class="toc-text">priority</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rule"><span class="toc-number">4.</span> <span class="toc-text">rule</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#属性"><span class="toc-number">4.1.</span> <span class="toc-text">属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#协议节点"><span class="toc-number">4.2.</span> <span class="toc-text">协议节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#action"><span class="toc-number">4.3.</span> <span class="toc-text">action</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用"><span class="toc-number">5.</span> <span class="toc-text">使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#命令行"><span class="toc-number">5.1.</span> <span class="toc-text">命令行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#API"><span class="toc-number">5.2.</span> <span class="toc-text">API</span></a></li></ol></li></ol></div></div><div class="post-content"><p>nwfilter（network filter）是libvirt中的网络数据包过滤子系统，用于过滤进出虚拟机的网络流量，仅支持qemu kvm虚拟机。本文主要记录官网文档中理解稍有困难的部分，其他更多详细信息参考<a href="https://libvirt.org/formatnwfilter.html" target="_blank" rel="noopener">官网文档 libvirt: Network Filters</a>。</p>
<p>本文操作系统环境为 CentOS Linux release 7.5.1804，libvirt使用版本为libvirt-3.9.0-14。</p>
<h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p>nwfilter以XML格式书写。一个nwfilter可以包含流量过滤规则，也可以引用其他nwfilter，两者可以同时存在。nwfilter以被虚拟机网卡接口引用的方式生效。其实现依赖ebtables、iptables和ip6tables工具。</p>
<p>以libvirt自带的clean-traffic为例说明nwfilter中的几个概念。</p>
<p><code>virsh nwfilter-dumpxml clean-traffic</code></p>
<figure class="highlight xml"><figcaption><span>clean-traffic</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">filter</span> <span class="attr">name</span>=<span class="string">'clean-traffic'</span> <span class="attr">chain</span>=<span class="string">'root'</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">uuid</span>&gt;</span>a2c07285-f55f-4f9a-8e3d-5bccd51052a6<span class="tag">&lt;/<span class="name">uuid</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filterref</span> <span class="attr">filter</span>=<span class="string">'no-mac-spoofing'</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filterref</span> <span class="attr">filter</span>=<span class="string">'no-ip-spoofing'</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">rule</span> <span class="attr">action</span>=<span class="string">'accept'</span> <span class="attr">direction</span>=<span class="string">'out'</span> <span class="attr">priority</span>=<span class="string">'-650'</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mac</span> <span class="attr">protocolid</span>=<span class="string">'ipv4'</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filterref</span> <span class="attr">filter</span>=<span class="string">'allow-incoming-ipv4'</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filterref</span> <span class="attr">filter</span>=<span class="string">'no-arp-spoofing'</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">rule</span> <span class="attr">action</span>=<span class="string">'accept'</span> <span class="attr">direction</span>=<span class="string">'inout'</span> <span class="attr">priority</span>=<span class="string">'-500'</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mac</span> <span class="attr">protocolid</span>=<span class="string">'arp'</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filterref</span> <span class="attr">filter</span>=<span class="string">'no-other-l2-traffic'</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filterref</span> <span class="attr">filter</span>=<span class="string">'qemu-announce-self'</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>filter<br>最外层元素filter是固定的，属性有name和chain。name是唯一的，nwfilter间不能冲突。chain是一个链的概念，有几种选择可以枚举，后面具体介绍。<ul>
<li>uuid<br>唯一的，可以由libvirt自动生成，不需要关注。</li>
<li>filterref<br>该元素代表了对另一个nwfilter的引用。其中只有一个属性filter，值为引用的另一个nwfilter的name。被引用的nwfilter中rule所属的chain不做变动，与引用者的chain无关。</li>
<li>rule<br>真正的过滤规则所在，有匹配规则、动作和优先级三种成分构成。action表示对数据包的动作，direction表示数据包需要匹配的方向，priority表示优先级（后面具体介绍）。<ul>
<li>mac<br>rule中的内部嵌套元素，该元素表示了rule中匹配的数据包协议类型，有几种类型可以枚举。其支持的属性与数据包类型有关，表示数据包需要匹配的规则。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>虚拟机配置中interface元素中嵌套插入filterref而生效该nwfilter，虚拟机如果变更引用的nwfilter需要关机重启，已经引用的nwfilter内容变更可以修改nwfilter而不需要重启虚拟机。</p>
<figure class="highlight xml"><figcaption><span>虚拟机interface配置</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">interface</span> <span class="attr">type</span>=<span class="string">'network'</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mac</span> <span class="attr">address</span>=<span class="string">'52:54:00:43:53:32'</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">source</span> <span class="attr">network</span>=<span class="string">'s-engine-net'</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">model</span> <span class="attr">type</span>=<span class="string">'virtio'</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filterref</span> <span class="attr">filter</span>=<span class="string">'s-engine-nwfilter'</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">'pci'</span> <span class="attr">domain</span>=<span class="string">'0x0000'</span> <span class="attr">bus</span>=<span class="string">'0x00'</span> <span class="attr">slot</span>=<span class="string">'0x03'</span> <span class="attr">function</span>=<span class="string">'0x0'</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">interface</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="chain"><a href="#chain" class="headerlink" title="chain"></a>chain</h2><p>nwfilter中过滤规则（rule）是以链（chain）的方式组织起来的。chain有几种值可以选择：</p>
<ul>
<li>root</li>
<li>mac</li>
<li>stp</li>
<li>vlan</li>
<li>arp、rarp</li>
<li>ipv4</li>
<li>ipv6</li>
</ul>
<p>上面的chain名字中，除root外其他的都可以作为一个名字的前缀（比如ipv4-a和ipv4-b）。rule需要挂载到一个chain上，既可以是root，也可以是其他chain。其他chain是挂载到root上的。所有数据包都先经过root（这里只说会先经过root，但不一定会流经root链中的rule，因为是否流经root上的某一个rule取决于该rule前面是否有更高优先级的其他rule或chain以及它们对数据包做何种裁决），其他chain的名字前缀表示了哪种协议类型的数据包会经过该chain，因此一个rule应该包含在哪个chain中需要考虑流经的数据包是否有意义（比如在arp的chain中过滤ipv4数据包是没有意义的）。</p>
<p>可以看到chain中没有四层的TCP或UDP等协议，这与chain的实现有关。nwfilter中chain的部分对应了ebtables对三层协议的匹配能力，因此chain只包含了三层协议的匹配。这里面的mac是二层协议，其实就是ebtables收到的所有数据包，不匹配三层协议就是它了，它与root所过滤的数据包是一致的，但是它是挂载到root上的。</p>
<p>chain在实现上依赖ebtables的nat表，因为nat表中包含了PREROUTING和POSTROUTING链，这是内核的两个hook点，可以过滤从虚拟机发出和进入虚拟机的流量。</p>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><p>nwfilter中的chain与ebtables中的chain（链）是直接对应的，chain的实现参考生成的ebtables规则会比较好理解，以一个配置例子说明：</p>
<figure class="highlight xml"><figcaption><span>s-engine-nwfilter</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">filter</span> <span class="attr">name</span>=<span class="string">'s-engine-nwfilter'</span> <span class="attr">chain</span>=<span class="string">'root'</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">uuid</span>&gt;</span>702687d4-e516-4eaa-9f40-1c81e0d3c38d<span class="tag">&lt;/<span class="name">uuid</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filterref</span> <span class="attr">filter</span>=<span class="string">'filter-test1'</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filterref</span> <span class="attr">filter</span>=<span class="string">'filter-test2'</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">rule</span> <span class="attr">action</span>=<span class="string">'drop'</span> <span class="attr">direction</span>=<span class="string">'out'</span> <span class="attr">priority</span>=<span class="string">'-400'</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ip</span> <span class="attr">protocol</span>=<span class="string">'udp'</span> <span class="attr">dstportstart</span>=<span class="string">'10086'</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">rule</span> <span class="attr">action</span>=<span class="string">'drop'</span> <span class="attr">direction</span>=<span class="string">'in'</span> <span class="attr">priority</span>=<span class="string">'-800'</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ip</span> <span class="attr">protocol</span>=<span class="string">'udp'</span> <span class="attr">dstportstart</span>=<span class="string">'10010'</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><figcaption><span>filter-test1</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">filter</span> <span class="attr">name</span>=<span class="string">'filter-test1'</span> <span class="attr">chain</span>=<span class="string">'ipv4-abc'</span> <span class="attr">priority</span>=<span class="string">'-700'</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">uuid</span>&gt;</span>35b50319-b597-4f12-acad-0fbaf3ab4303<span class="tag">&lt;/<span class="name">uuid</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">rule</span> <span class="attr">action</span>=<span class="string">'drop'</span> <span class="attr">direction</span>=<span class="string">'out'</span> <span class="attr">priority</span>=<span class="string">'500'</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ip</span> <span class="attr">protocol</span>=<span class="string">'udp'</span> <span class="attr">dstportstart</span>=<span class="string">'9999'</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><figcaption><span>filter-test2</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">filter</span> <span class="attr">name</span>=<span class="string">'filter-test2'</span> <span class="attr">chain</span>=<span class="string">'mac-def'</span> <span class="attr">priority</span>=<span class="string">'-600'</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">uuid</span>&gt;</span>1b432e1a-e1c8-49d6-be02-fff48a3b2928<span class="tag">&lt;/<span class="name">uuid</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">rule</span> <span class="attr">action</span>=<span class="string">'drop'</span> <span class="attr">direction</span>=<span class="string">'out'</span> <span class="attr">priority</span>=<span class="string">'500'</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ip</span> <span class="attr">protocol</span>=<span class="string">'udp'</span> <span class="attr">dstportstart</span>=<span class="string">'9996'</span> <span class="attr">dstportend</span>=<span class="string">'9999'</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>运行命令<code>ebtables -t nat -L</code>可以看到ebtables中生成的规则：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Bridge table: nat</span><br><span class="line"></span><br><span class="line">Bridge chain: PREROUTING, entries: 1, policy: ACCEPT</span><br><span class="line">-i vnet1 -j libvirt-I-vnet1</span><br><span class="line"></span><br><span class="line">Bridge chain: OUTPUT, entries: 0, policy: ACCEPT</span><br><span class="line"></span><br><span class="line">Bridge chain: POSTROUTING, entries: 1, policy: ACCEPT</span><br><span class="line">-o vnet1 -j libvirt-O-vnet1</span><br><span class="line"></span><br><span class="line">Bridge chain: libvirt-I-vnet1, entries: 3, policy: ACCEPT</span><br><span class="line">-p IPv4 -j I-vnet1-ipv4-abc</span><br><span class="line">-j I-vnet1-mac-def</span><br><span class="line">-p IPv4 --ip-proto udp --ip-dport 10086 -j DROP</span><br><span class="line"></span><br><span class="line">Bridge chain: libvirt-O-vnet1, entries: 1, policy: ACCEPT</span><br><span class="line">-p IPv4 --ip-proto udp --ip-dport 10010 -j DROP</span><br><span class="line"></span><br><span class="line">Bridge chain: I-vnet1-ipv4-abc, entries: 1, policy: ACCEPT</span><br><span class="line">-p IPv4 --ip-proto udp --ip-dport 9999 -j DROP</span><br><span class="line"></span><br><span class="line">Bridge chain: I-vnet1-mac-def, entries: 1, policy: ACCEPT</span><br><span class="line">-p IPv4 --ip-proto udp --ip-dport 9996:9999 -j DROP</span><br></pre></td></tr></table></figure>
<p>nwfilter解释如下：</p>
<ul>
<li>s-engine-nwfilter<br>配置了名为root的chain，这个chain最先接收所有的数据包，因此不需要优先级。同时引用filter-test1和filter-test2（引用者和被引用者的chain没有任何关系，纯粹是单纯的并列关系）。</li>
<li>filter-test1<br>配置了名为ipv4-abc的chain，从名字前缀可以看到这个chain接收三层协议为IPV4的数据包，优先级-700（chain中优先级范围为[-1000, 1000]，数字越小越优先）。</li>
<li>filter-test2<br>配置名为mac-def的chain，从名字前缀可以看到这个chain接收二层数据包，优先级-600。</li>
</ul>
<p>对比ebtables中的规则：</p>
<ul>
<li>PREROUTING链<br>将vnet1（虚拟机网卡在host上对应该端口）上进入网桥的数据包（也就是虚拟机发出的数据包）跳转到用户自定义链libvirt-I-vnet1中。<ul>
<li>libvirt-I-vnet1链<br>这个链其实就对应名为root的chain，但它只是该chain的一半，负责虚拟机向外发出的数据包。包含了直接挂载到root上的direction为out的rule，比如这里的将IPV4协议数据包中上层协议为UDP且目的端口为10086的数据包drop掉。还挂载的其他chain（如果这个chain中包含了direction为out的rule）。比如IPV4数据包跳转用户自定义链I-vnet1-ipv4-abc，比如所有数据包跳转用户自定义链I-vnet1-mac-def。<ul>
<li>I-vnet1-ipv4-abc链<br>对应名为ipv4-abc的chain的一半。挂载了一条rule，将IPV4协议数据包中上层协议为UDP且目的端口9999的数据包drop掉。</li>
<li>I-vnet1-mac-def链<br>对应名为mac-def的chain的一般。挂载了一条rule，将IPV4协议数据包中上层协议为UDP且目的端口从9996到9999的数据包drop掉。</li>
</ul>
</li>
</ul>
</li>
<li>POSTROUTING链<br>将要发往vnet1的数据包（也就是虚拟机将要接收的数据包）跳转到用户自定义链libvirt-O-vnet1中。<ul>
<li>libvirt-O-vnet1链<br>同libvirt-I-vnet1一样也都对应名为root的chain，区别在于这个链负责发往虚拟机的数据包。由于该方向只有一条rule，而且是直接挂载到root上的，因此该链上只有一条规则，没有其他用户自定义链的跳转。</li>
</ul>
</li>
</ul>
<h2 id="priority"><a href="#priority" class="headerlink" title="priority"></a>priority</h2><p><a href="./#实现">实现一节</a>中说明了chain和其中的rule如何对应到ebtables中，由于chain和rule都有priority属性，因此实际使用时还要注意priority（优先级）的配置。</p>
<ul>
<li>rule靠优先级与同一chain上的其他rule做排序。</li>
<li>非root的chain靠优先级与其他chain做排序。</li>
<li>root上的rule和chain是并列关系，靠优先级做混合排序。</li>
</ul>
<p>比如ebtables中的这一段，由于libvirt-I-vnet1对应了名为root的chain，可以看到对应名为ipv4-abc和mac-def的两个chain和root上该方向上的rule通过优先级做了混合排序。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Bridge chain: libvirt-I-vnet1, entries: 3, policy: ACCEPT</span><br><span class="line">-p IPv4 -j I-vnet1-ipv4-abc</span><br><span class="line">-j I-vnet1-mac-def</span><br><span class="line">-p IPv4 --ip-proto udp --ip-dport 10086 -j DROP</span><br></pre></td></tr></table></figure>
<p>chain在不配置priority时，libvirt会赋予默认优先级，参考<a href="https://libvirt.org/formatnwfilter.html#nwfconceptschainpriorities" target="_blank" rel="noopener">官网文档</a>。</p>
<p><img src="http://blog-image.hyuuhit.com/2018/12/nwfilter-chain.jpg" alt="priority关系"></p>
<h2 id="rule"><a href="#rule" class="headerlink" title="rule"></a>rule</h2><p>一个rule代表了一个过滤规则，一个rule节点可以包含几个属性以及内部嵌套的协议节点。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">rule</span> <span class="attr">action</span>=<span class="string">'drop'</span> <span class="attr">direction</span>=<span class="string">'in'</span> <span class="attr">priority</span>=<span class="string">'-800'</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ip</span> <span class="attr">protocol</span>=<span class="string">'udp'</span> <span class="attr">dstportstart</span>=<span class="string">'10010'</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h3><ul>
<li>action<br>必选项。可以选择以下几种：<ul>
<li>drop<br>直接丢弃数据包。</li>
<li>reject<br>丢弃数据包并生成一个ICMP消息。</li>
<li>accept<br>接收该数据包并跳过其他所有chain和rule。</li>
<li>return<br>跳过当前chain上的其他过滤器，并返回到root上继续检查后续chain或rule。如果当前位于root，则接收该数据包。</li>
<li>continue<br>不产生影响，可以用于计数。</li>
</ul>
</li>
<li>direction<br>必选项。可以选择以下几种：<ul>
<li>in<br>进入虚拟机的数据包。</li>
<li>out<br>虚拟机发出的数据包。</li>
<li>inout<br>双向数据包。</li>
</ul>
</li>
<li>priority<br>rule的优先级。</li>
<li>statematch<br>默认是true。对于四层协议可以对放行的数据包所对应的连接做状态保持，也就是放行该连接的后续数据包，该功能依赖iptables或ip6tables。这避免ebtables单纯判定一方端口的情况，对于防御攻击效果更好。</li>
</ul>
<h3 id="协议节点"><a href="#协议节点" class="headerlink" title="协议节点"></a>协议节点</h3><p>rule内部嵌套的协议节点代表了该rule需要匹配何种协议。三层协议依赖ebtables，四层协议依赖iptables和ip6tables。每种协议节点有不同的过滤属性。具体信息参考<a href="https://libvirt.org/formatnwfilter.html#nwfelemsRulesProto" target="_blank" rel="noopener">官网文档</a>。</p>
<p>需要说明的是由于nwfilter在三层协议数据包处理上依赖ebtables，四层协议数据包处理上依赖iptables（或ip6tables），而这两种工具在内核中使用的是不同的hook点。也就是说同一个数据包，可能在ebtables中被accept了，但是在iptables中可能做出不同的裁决（比如drop），这里对该情况做明确说明。</p>
<p>如果有一组复杂的nwfilter，某一个rule中配置了ip协议节点的过滤规则并且做了accept裁决，另一个rule中配置了tcp协议节点的过滤规则并且做了drop裁决，当一个数据包同时匹配了这两个rule时，将会首先经过ebtables并accept通过，然后经过iptables并被drop丢弃。三层节点与四层节点过滤器的先后关系与rule的priority完全无关，四层节点之间比较时priority才有意义。</p>
<p>除了明显的四层协议名节点，all这个节点名也是生效到iptables中的。</p>
<p>虽然三层ip协议节点可以通过属性protocol配置过滤简单的四层协议头信息，但如果使用中存在四层协议节点，那么推荐在三层协议节点中对出入的ip数据包都做accept处理，但是优先级靠后（比如libvirt提供的<a href="./#概念">clean-traffic</a>），这样可以在靠前的位置放置各种防伪造策略，然后将所有四层相关的过滤规则都使用四层协议节点配置，这样既避免了逻辑上的混淆，同时也利用了四层协议节点默认的状态保持功能。比如以下配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">filter</span> <span class="attr">name</span>=<span class="string">'s-engine-filter'</span> <span class="attr">chain</span>=<span class="string">'root'</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">uuid</span>&gt;</span>4f446dac-30a6-444e-8118-9a15c959fac5<span class="tag">&lt;/<span class="name">uuid</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filterref</span> <span class="attr">filter</span>=<span class="string">'clean-traffic'</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">rule</span> <span class="attr">action</span>=<span class="string">'return'</span> <span class="attr">direction</span>=<span class="string">'in'</span> <span class="attr">priority</span>=<span class="string">'500'</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">all</span> <span class="attr">srcipfrom</span>=<span class="string">'172.16.128.0'</span> <span class="attr">srcipto</span>=<span class="string">'172.16.255.254'</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">rule</span> <span class="attr">action</span>=<span class="string">'return'</span> <span class="attr">direction</span>=<span class="string">'out'</span> <span class="attr">priority</span>=<span class="string">'500'</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tcp</span> <span class="attr">dstipaddr</span>=<span class="string">'172.16.0.1'</span> <span class="attr">dstportstart</span>=<span class="string">'1821'</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">rule</span> <span class="attr">action</span>=<span class="string">'return'</span> <span class="attr">direction</span>=<span class="string">'out'</span> <span class="attr">priority</span>=<span class="string">'500'</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">udp</span> <span class="attr">srcipaddr</span>=<span class="string">'0.0.0.0'</span> <span class="attr">dstipaddr</span>=<span class="string">'255.255.255.255'</span> <span class="attr">srcportstart</span>=<span class="string">'68'</span> <span class="attr">dstportstart</span>=<span class="string">'67'</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">rule</span> <span class="attr">action</span>=<span class="string">'return'</span> <span class="attr">direction</span>=<span class="string">'in'</span> <span class="attr">priority</span>=<span class="string">'500'</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">udp</span> <span class="attr">srcipaddr</span>=<span class="string">'172.16.0.1'</span> <span class="attr">srcportstart</span>=<span class="string">'67'</span> <span class="attr">dstportstart</span>=<span class="string">'68'</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">rule</span> <span class="attr">action</span>=<span class="string">'drop'</span> <span class="attr">direction</span>=<span class="string">'inout'</span> <span class="attr">priority</span>=<span class="string">'1000'</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">all</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>引用clean-traffic，确保虚拟机不会发出各种伪造数据包，只让干净合法的流量出入。</li>
<li>其余都使用四层协议节点配置，生效到iptables。<ul>
<li>对来源在172.16.128.0到172.16.255.254范围内的入包做放行，并保持连接状态放行相应的出包。</li>
<li>对目的地址172.16.0.1，目的端口1821的UDP数据出包做放行，并保持连接状态。</li>
<li>后面两条是对DHCP协议数据包做放行，其中172.16.0.1是DHCP服务器地址。</li>
<li>丢弃其他所有的四层数据包（这个prirority优先级最低）。</li>
</ul>
</li>
</ul>
<h3 id="action"><a href="#action" class="headerlink" title="action"></a>action</h3><p>关于action有一点需要特别说明。ebtables的用户自定义链是有policy的（iptables用户自定义链没有policy），而且libvirt使用的是默认policy，也就是accept。这就是说如果数据包被跳转到一个chain，而该chain中的rule并没有对数据包做出裁决，最后将会生效该chain的默认policy，也就是accept，这阻止了数据包继续被其他chain或rule检查。如果不注意这一点有可能导致实际效果与预期不符。</p>
<p>以<a href="./#实现">实现一节中的例子</a>来说，由于名为ipv4-abc的chain比名为mac-def的chain优先级配置数字更小，因此IPV4数据包会先被跳转到ipv4-abc链中，如果虚拟机发出一个目的端口是9996的UDP数据包，该链并没有drop该数据包，最后该链的policy会accept该数据包，而mac-def中的rule将不会如预期drop该数据包。</p>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>nwfilter的使用比较简单，分为命令行和API两种方式。</p>
<h3 id="命令行"><a href="#命令行" class="headerlink" title="命令行"></a>命令行</h3><p>命令<code>virsh help filter</code>可以查看nwfilter相关的命令。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Network Filter (help keyword &apos;filter&apos;):</span><br><span class="line">   nwfilter-define                define or update a network filter from an XML file</span><br><span class="line">   nwfilter-dumpxml               network filter information in XML</span><br><span class="line">   nwfilter-edit                  edit XML configuration for a network filter</span><br><span class="line">   nwfilter-list                  list network filters</span><br><span class="line">   nwfilter-undefine              undefine a network filter</span><br></pre></td></tr></table></figure>
<h3 id="API"><a href="#API" class="headerlink" title="API"></a>API</h3><p>API的使用直接参考官网文档就可以了。</p>
<p><a href="https://libvirt.org/html/libvirt-libvirt-nwfilter.html" target="_blank" rel="noopener">API列表 - Module libvirt-nwfilter from libvirt</a><br><a href="https://libvirt.org/html/index.html" target="_blank" rel="noopener">更多API - Reference Manual for libvirt</a><br><a href="https://libvirt.org/format.html" target="_blank" rel="noopener">XML Format</a></p>
<p>PS：使用API对已经存在的nwfilter做修改时，需要先拿到旧的uuid，在XML文本中设置该uuid，再调用<a href="https://libvirt.org/html/libvirt-libvirt-nwfilter.html#virNWFilterDefineXML" target="_blank" rel="noopener"><code>virNWFilterDefineXML</code></a>函数。</p>
</div><div class="tags"><a href="/tags/工具/">工具</a></div><div class="post-nav"><a class="pre" href="/2019/01/04/nonblock-redis/">hiredis &amp; libev 非阻塞模式</a><a class="next" href="/2018/12/03/libxml2/">libxml2 简单使用</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://www.hyuuhit.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/libvirt/">libvirt</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/suricata/">suricata</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/工具/" style="font-size: 15px;">工具</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/vmware/" style="font-size: 15px;">vmware</a> <a href="/tags/数据结构/" style="font-size: 15px;">数据结构</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2022/09/16/tc-tbf-qdisc/">tc tbf qdisc</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/08/08/function-call-stack/">gdb查看寄存器及内存数据与函数调用栈分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/11/16/libpcap-cutoff-captured-packet/">libpcap在libvirt虚拟化环境下捕获数据包不完整的一种情况分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/08/27/bash-audit/">一种简单的bash审计方法</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/08/20/bash-invocation/">bash 调用方式与配置文件</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/08/17/uriparser/">uriparser 解析处理URI</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/06/noblock-rabbitmq-c/">rabbitmq-c 非阻塞订阅</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/20/libyaml/">libyaml 解析配置文件</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/23/netns/">Linux network namespace 简单解读</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/11/af-packet-bpf/">AF_PACKET & BPF 伪造arp响应</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2022 <a href="/." rel="nofollow">属乌鸦的.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>